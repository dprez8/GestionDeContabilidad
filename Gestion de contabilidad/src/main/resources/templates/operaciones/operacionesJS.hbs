const operaciones = {
    template: `{{> operaciones/operacionesHTML.hbs}}`,
    data() {
        return {
            egresos: [],
            ingresos: [],
            egresoLoading: true,
            egresosLoading: false,
            egresoSelected: null,

            ingresosLoading: false,
            campos_egresos: [
                { key: 'name', label: 'Egreso', thClass:['w-100'], tdClass:[] },
                { key: 'validado', label: 'Estado', thClass:['text-center'], tdClass:['text-center'] },
                { key: 'valorTotal', label: 'Total', thClass:['text-center'], tdClass:['text-center'] },
                { key: 'fechaOperacion', label: 'Emitido', thClass:['text-center'], tdClass:['text-center'] }
            ],
            campos_ingresos: [
                { key: 'name', label: 'Ingreso', thClass:['w-25'], tdClass:[] },
                { key: 'descripcion', label: 'Descripcion', thClass:['w-50'], tdClass:['mw-0'] },
                { key: 'montoTotal', label: 'Total', thClass:['text-center'], tdClass:['text-center'] },
                { key: 'fechaOperacion', label: 'Fecha OperaciÃ³n', thClass: ['text-center', 'w-25'], tdClass: ['text-center'] },
            ],
            transProps: {
              name: "fade"
            }
        }
    },
    methods: {
        convertDate: convertDate,
        cargarEgresosAPI(){
            if(!this.egresoOpened()) 
                return;

            this.egresosLoading = true;
            $.ajax({
                url: "http://{{ ip }}/api/operaciones/egresos",
                type: "GET",
                dataType: "json",
                context: this,
                success(response) {
                    if(response.code == 403) {
                        app.showSessionEndedAlert(true);
                    } else if(response.code == 200) {
                        console.log(response);
                        this.egresos = response.egresos.map(this.egresosAPIConverter);
                    }
                },
                error(response) {
                    console.log("error");
                    console.log(response);
                },
                complete() {
                    this.egresosLoading = false;
                }
            });
        },
        egresosAPIConverter(egresoAPI) {
            return {
                id: egresoAPI.id,
                name: 'Egreso ' + egresoAPI.id,
                validado: egresoAPI.validado,
                valorTotal: egresoAPI.valorTotal,
                fechaOperacion: convertDate(egresoAPI.fechaOperacion),
                _showDetails: true,
                showEgreso: false
            }
        },
        toggleEgreso(row) {
            if(!row.showEgreso) {
                this.$router.push('/operaciones/egreso/'+ row.id);
            } else {
                this.$router.push('/operaciones/egreso');
            }
        },
        seleccionarEgreso() {
            var id = this.$route.params.id;
            this.egresoLoading = true;

            this.egresos.forEach(egreso => {
                if(egreso.id != id)
                    egreso.showEgreso = false;
                else
                    egreso.showEgreso = true;
            });
        },
        egresoLoaded(){
            this.egresoLoading = false;
        },
        egresoOpened() {
            return (this.$route.name == 'egresos' || this.$route.name == 'egreso');
        },

        cargarIngresosAPI(){
            if(!this.ingresoOpened()) 
                return;
            
            this.ingresosLoading = true;
            $.ajax({
                url: "http://{{ ip }}/api/operaciones/ingresos",
                type: "GET",
                dataType: "json",
                context: this,
                success(response) {
                    if(response.code == 403) {
                        app.showSessionEndedAlert(true);
                    } else if(response.code == 200) {
                        console.log(response);
                        this.ingresos = response.ingresos.map(this.ingresosAPIConverter);
                    }
                },
                error(response) {
                    console.log("error");
                    console.log(response);
                },
                complete() {
                    this.ingresosLoading = false;
                }
            });
        },
        ingresosAPIConverter(ingresoAPI) {
            return {
                id: ingresoAPI.id,
                name: 'Ingreso ' + ingresoAPI.id,
                descripcion: ingresoAPI.descripcion,
                montoTotal: ingresoAPI.montoTotal,
                fechaOperacion: convertDate(ingresoAPI.fechaOperacion),
                _showDetails: true,
                showEgreso: false
            }
        },
        ingresoOpened() {
            return (this.$route.name == 'ingresos');
        },
        rowStyle(item, type) {
            if(type == 'row') {
                if(item.showEgreso) {
                    return ['bg-secondary', 'text-light'];
                }
            }
        }
    },
    components: {
        'egreso': egreso
    },
    watch: {
        $route(to, from) {
            if(this.$route.name == 'egresos')
                this.cargarEgresosAPI();
            this.cargarIngresosAPI();
            this.seleccionarEgreso();
        },
        egresosLoading(to, from) {
            if(to == false) {
                this.seleccionarEgreso();
            }
        }
    },
    mounted() {
        this.cargarEgresosAPI();
        this.cargarIngresosAPI();
        this.seleccionarEgreso();
    }
};