const egreso = {
    props: {
        egresoLoaded: Function,
        ingresos: Array
    },
    template: `{{> egreso/egresoHTML.hbs}}`,
    data() {
        return {
            egreso: null,
            campos_items: [
                {
                    key: 'producto',
                    label: 'Producto',
                    tdClass: ['w-50'],
                    thClass: []
                },
                {
                    key: 'cantidad',
                    label: 'Cantidad',
                    tdClass: ['text-center'],
                    thClass: ['text-center']
                },
                {
                    key: 'precio',
                    label: 'Precio',
                    tdClass: ['text-center'],
                    thClass: ['text-center']
                }
            ],
            falloAsociacionIngreso: false
        }
    },
    methods: {
        convertDate: convertDate,
        cargarEgresoAPI() {
            var id = this.$route.params.id;
            if(id == undefined)
                return;

            $.ajax({
                url: "http://{{ ip }}/api/operaciones/egreso/"+id,
                type: "GET",
                dataType: "json",
                context: this,
                cache: false,
                success(response) {
                    if(response.code == 403) {
                        app.showSessionEndedAlert(true);
                    } else if(response.code == 200) {
                        console.log(response);
                        this.egreso = response.egreso;
                        this.egreso.items = response.egreso.items.map(this.itemEgresoAPIConverter);
                    } else {
                        app.createCommonErrors(response);
                    }
                },
                error(data) {
                    app.createCommonErrors(data);
                },
                complete() {
                    this.egresoLoaded();
                }
            });
        },
        itemEgresoAPIConverter(item) {
            return {
                producto: item.producto.nombreProducto,
                cantidad: item.cantidad,
                precio: item.precio
            }
        },
        // Ingreso
        confirmarAsociarIngreso(data) {

            this.falloAsociacionIngreso = false;

            this.$bvModal.hide('modal-asociar-ingreso');
            console.log(data);

            var ingreso = data;

            if(ingreso) {

                var request = {
                    egresoId: this.egreso.id,
                    ingresoId: ingreso.id
                }

                console.log("POST '/api/operaciones/asociarManualmente'");
                console.log(JSON.stringify(request, null, 4));

                $.ajax({
                    url: "http://{{ ip }}/api/operaciones/asociarManualmente",
                    type: "POST",
                    dataType: "json",
                    context: this,
                    data: JSON.stringify(request),
                    success(response) {
                        if(response.code == 403) {
                            app.showSessionEndedAlert(true);
                        } else if(response.code == 400) {
                            // Fallo la asociacion de ingreso
                            this.falloAsociacionIngreso = true;
                        } else if(response.code == 200) {
                            // El ingreso se asoci√≥ correctamente
                            console.log(response);
                            app.softReloadPage();
                        } else {
                            // Fallo la asociacion de ingreso (default)
                            this.falloAsociacionIngreso = true;
                            app.createCommonErrors(response);
                        }
                    },
                    error(data) {
                        this.falloAsociacionIngreso = true;
                        app.createCommonErrors(data);
                    }
                });
            } 

        },
        cancelarAsociarIngreso() {
            this.$bvModal.hide('modal-asociar-ingreso');
        },
        // Categorias
        confirmarAsociarCategorias(data) {
            this.$bvModal.hide('modal-asociar-categoria');
            console.log(data);

            var categorias = data;

            if(categorias) {

                var request = {
                    id: this.egreso.id,
                    categorias: categorias.map(function(categoria){
                        return categoria.id;
                    }),
                }

                console.log("POST '/api/categorias/asociar'");
                console.log(JSON.stringify(request, null, 4));

                $.ajax({
                    url: "http://{{ ip }}/api/categorias/asociar",
                    type: "POST",
                    dataType: "json",
                    context: this,
                    data: JSON.stringify(request),
                    success(response) {
                        if(response.code == 403) {
                            app.showSessionEndedAlert(false);
                        } else if(response.code == 400) {
                            // Fallo la asociacion de categorias
                            this.falloCarga = true;
                        } else if(response.code == 200) {
                            // Las categorias se asociaron correctamente
                            console.log(response);
                            app.softReloadPage();
                        } else {
                            // Fallo la asociacion de categorias (default)
                            this.falloCarga = true;
                            app.createCommonErrors(response);
                        }
                    },
                    error(data) {
                        this.falloCarga = true;
                        app.createCommonErrors(data);
                    }
                });
            }
        },
        cancelarAsociarCategorias() {
            this.$bvModal.hide('modal-asociar-categoria');
        },
    },
    mounted() {
        this.cargarEgresoAPI();
    },
    components: {
        'asociar-ingreso': asociarIngreso,
        'asociar-categoria': asociarCategoria
    }
}